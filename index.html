<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>Ten Seconds To Venus</title>
<style>

body
{
	background: #000;
	margin: 0;
	font: 1rem monospace; color: #fff;
	overflow: hidden;
}

#Intro
{
	padding: 2rem;
	text-align: center;
	line-height: 150%;
}

</style>
<head>
<body>
<div id="Intro">
<h1>2175</h1>
<p>You are on board of a space station in Venus orbit.</p>
<p>You are sleeping.</p>
<p>You wake from a roaring BANG!</p>
<p>(Loading ...)</p>
</div>
<script>

"use strict";

var Canvas;
(function()
{
	var ratio;

	Canvas = function()
	{
		var e = document.createElement( "canvas" ),
			ctx = e.getContext( "2d" );

		this.domElement = e;
		this.context = ctx;

		ratio = ratio ||
			(window.devicePixelRatio || 1)/
			(ctx.webkitBackingStorePixelRatio ||
				ctx.mozBackingStorePixelRatio ||
				ctx.msBackingStorePixelRatio ||
				ctx.oBackingStorePixelRatio ||
				ctx.backingStorePixelRatio ||
				1)
	};

	Canvas.prototype.resize = function( width, height )
	{
		var e = this.domElement;

		this.width = width;
		this.height = height;

		e.width = Math.round( width*ratio );
		e.height = Math.round( height*ratio );
		e.style.width = width+"px";
		e.style.height = height+"px";

		this.context.setTransform(
			ratio,
			0,
			0,
			ratio,
			0,
			0 );
	};

	Canvas.prototype.pos = function( ev )
	{
		var x,
			y;

		if( ev.touches )
		{
			var t = ev.touches[0];

			x = t.pageX;
			y = t.pageY;
		}
		else if( window.opera )
		{
			x = event.clientX;
			y = event.clientY;
		}
		else if( document.all )
		{
			if( document.documentElement &&
				document.documentElement.scrollTop )
			{
				x = event.clientX+document.documentElement.scrollLeft;
				y = event.clientY+document.documentElement.scrollTop;
			}
			else
			{
				x = event.clientX+document.body.scrollLeft;
				y = event.clientY+document.body.scrollTop;
			}
		}
		else
		{
			x = ev.pageX;
			y = ev.pageY;
		}

		return { x: x, y: y }
	};
}( Canvas ));

var Game = (function()
{
	var objects = {
			venus: {
				draw: drawVenus,
				swirl: 0,
				res: ["venus.png"] },
			station: {
				draw: drawStation,
				res: [
					"station.png",
					"station_burned.png"] },
			boosterTop: {
				ox: -371,
				oy: -179,
				draw: drawBooster,
				res: ["booster_top.png"] },
			boosterBottom: {
				ox: 250,
				oy: 174,
				draw: drawBooster,
				res: ["booster_bottom.png"] },
			water: {
				use: function()
				{
					say( "It's getting hot so why not drink something?" );
					return true;
				},
				ox: 116,
				oy: -39,
				index: 0,
				res: ["item_water.png"] },
			food: {
				use: function()
				{
					say( "Good, feeling better now." );
					return true;
				},
				ox: -8,
				oy: 24,
				index: 0,
				res: ["item_food.png"] },
			medpack: {
				use: function()
				{
					say( "Good to have." );
					return true;
				},
				ox: 156,
				oy: 33,
				index: 0,
				res: ["item_medpack.png"] },
			screwdriver: {
				use: function()
				{
					var m;

					if( objects.astronaut.hasComputer )
						m = "That doesn't work, it's too big";
					else
						m = "Have it, what now?";

					say( m );
					return true;
				},
				ox: -71,
				oy: 27,
				index: 0,
				res: ["item_screwdriver.png"] },
			pen: {
				use: function()
				{
					var m;

					objects.astronaut.hasPen = true;

					if( objects.astronaut.hasComputer )
					{
						fireBoosters();
						m = "Wait, the pen fits in that restart "+
							"hole of the computer, yes!";
					}
					else
						m = "Ok.";

					say( m );
					return true;
				},
				ox: -91,
				oy: -11,
				index: 0,
				res: ["item_pen.png"] },
			manual: {
				use: function()
				{
					say( "Well, lets see, something about boosters..." );
					return true;
				},
				ox: -142,
				oy: 28,
				index: 0,
				res: ["item_manual.png"] },
			helmet: {
				use: function()
				{
					objects.astronaut.hasHelmet = true;

					if( !objects.astronaut.hasSuit )
						say( "Where's my suit?" );
					else
						say( "Ok, now I'm safe!" );

					return true;
				},
				ox: -140,
				oy: -45,
				index: 0,
				res: ["item_helmet.png"] },
			suit: {
				use: function()
				{
					objects.astronaut.hasSuit = true;

					if( !objects.astronaut.hasHelmet )
						say( "Where's my helmet?" );
					else
						say( "That's a good idea!" );

					return true;
				},
				ox: 54,
				oy: -13,
				index: 0,
				res: ["item_suit.png"] },
			sleepbag: {
				use: function()
				{
					say( "Got it." );
					return true;
				},
				ox: -340,
				oy: 15,
				index: 0,
				res: ["item_sleepbag.png"] },
			wires: {
				use: function()
				{
					say( "Got them." );
					return true;
				},
				ox: -297,
				oy: 15,
				index: 0,
				res: ["item_wires.png"] },
			lamp: {
				use: function()
				{
					say( "Ok, now I have light!" );
					objects.lamp.index = 1;
				},
				ox: -28,
				oy: -55,
				index: 0,
				res: [
					"item_lamp.png",
					"item_lamp_on.png"] },
			camera: {
				use: function()
				{
					say( "You really think I should take a picture now?" );
				},
				ox: -333,
				oy: -62,
				index: 0,
				res: ["item_camera.png"] },
			computer: {
				use: function()
				{
					var m;

					objects.astronaut.hasComputer = true;

					if( objects.astronaut.hasPen )
					{
						fireBoosters();
						m = "It crashed! Good I had the pen to restart it!";
					}
					else
						m = "I could start the boosters! Oh no! It crashed!";

					say( m );
					return true;
				},
				ox: 160,
				oy: -26,
				index: 0,
				res: ["item_computer.png"] },
			astronaut: {
				draw: drawAstronaut,
				ox: -248,
				oy: 0,
				index: 0,
				res: [
					"astronaut0.png",
					"astronaut1.png",
					"astronaut2.png",
					"astronaut_helmet.png",
					"astronaut_suit.png",
					"astronaut_suited.png"] },
			heat: {
				draw: drawHeat,
				res: [
					"heat.png",
					"heat_burning.png"] }
		},
		ref = [1024, 273],
		canvas,
		ctx,
		centerX,
		centerY,
		fontSize,
		now,
		start,
		uptime,
		moving,
		floating,
		loadTimer = null,
		running = false,
		killed = false,
		fireBoostersUntil = 0,
		messageGoodUntil = 0,
		message = null;

	function fireBoosters()
	{
		fireBoostersUntil = now+2000;
	}

	function say( what )
	{
		messageGoodUntil = new Date().getTime()+2000;
		message = what;
	}

	function drawVenus( obj )
	{
		var img = obj.images[0];

		if( !fireBoostersUntil )
		{
			var t = now*.001,
				r = obj.swirl,
				x = Math.round( centerX+r*Math.cos( t ) ),
				y = Math.round( centerY+r*Math.sin( t ) ),
				s = uptime < 10000 ?
					Math.round( img.width+
						(canvas.width-img.width)/10000*uptime ) :
					canvas.width,
				hs = Math.round( s/2 );

			obj.x = x-hs;
			obj.y = y-hs;
			obj.size = s;
		}

		ctx.drawImage(
			img,
			obj.x,
			obj.y,
			obj.size,
			obj.size );
	}

	function drawStation( obj )
	{
		var img = obj.images[killed ? 1 : 0];

		ctx.drawImage( img, centerX-img.cx, centerY-img.cy );
	}

	function drawBooster( obj )
	{
		if( !fireBoostersUntil ||
			fireBoostersUntil < now )
			return;

		var img = obj.images[0],
			x = centerX+obj.x,
			y = centerY+obj.y;

		ctx.drawImage( img, x-img.cx, y-img.cy );
	}

	function drawAstronaut( obj )
	{
		if( killed )
			return;

		var img,
			x,
			y = centerY+obj.y+Math.sin( now*.005 )*floating;

		if( obj.grab &&
			obj.grabDist != 0 )
		{
			var g = obj.grab;

			obj.x += obj.grabDist > 0 ? moving : -moving;

			if( (obj.grabDist > 0 && obj.x >= g.x) ||
				(obj.grabDist < 0 && obj.x <= g.x) )
			{
				if( g.use )
					g.taken = g.use();

				obj.x = g.x;
				obj.grab = null;
			}
		}

		if( !img )
		{
			x = Math.round( centerX+obj.x );

			if( obj.hasHelmet && obj.hasSuit )
				img = obj.images[5];
			else if( obj.hasHelmet )
				img = obj.images[3];
			else if( obj.hasSuit )
				img = obj.images[4];
			else
				img = obj.images[fireBoostersUntil ? 0 :
					Math.round( now/500 )%3];
		}

		ctx.drawImage( img, x-img.cx, y-img.cy );
	}

	function drawHeat( obj )
	{
		if( fireBoostersUntil )
			return;

		if( uptime < 10000 )
		{
			var img = obj.images[0];

			ctx.globalAlpha = 1/10000*uptime;
			ctx.drawImage( img, centerX-img.cx, centerY-img.cy );
			ctx.globalAlpha = 1;
		}

		if( uptime > 9000 &&
			uptime < 12000 )
		{
			var img = obj.images[1],
				f = 1/3000*(uptime-9000);

			ctx.globalAlpha = Math.min( f, 1-f )*2;
			ctx.drawImage( img, centerX-img.cx, centerY-img.cy );
			ctx.globalAlpha = 1;
		}
	}

	function draw()
	{
		now = new Date().getTime();
		uptime = now-start;

		ctx.fillStyle = '#000';
		ctx.fillRect(
			0,
			0,
			canvas.width,
			canvas.height );

		if( uptime > 10000 &&
			!killed &&
			!fireBoostersUntil )
		{
			say( "AAAARGHHHH!!" );
			killed = true;
		}

		for( var name in objects )
		{
			var obj = objects[name];

			if( obj.draw )
				obj.draw( obj );
			else if(
				!killed &&
				!obj.taken )
			{
				var img = obj.images[obj.index],
					x = centerX+obj.x,
					y = centerY+obj.y+Math.sin(
						now*.005+obj.x )*floating;

				obj.left = x-img.cx;
				obj.top = y-img.cy;
				obj.right = obj.left+img.width;
				obj.bottom = obj.top+img.height;

				ctx.drawImage( img, obj.left, obj.top );
			}
		}

		if( messageGoodUntil > now &&
			message )
		{
			ctx.font = "bold "+fontSize+"px monospace";
			ctx.textAlign = "center";
			ctx.textBaseline = "middle";
			ctx.fillStyle = "#fff";
			ctx.fillText(
				message,
				centerX,
				fontSize );
		}
	}

	function run()
	{
		draw();
		requestAnimFrame( run );
	}

	function click( ev )
	{
		if( fireBoostersUntil )
			return true;
		else if( killed  )
		{
			if( uptime > 12000 )
				reset();

			return true;
		}

		var pos = canvas.pos( ev ),
			x = pos.x,
			y = pos.y;

		for( var name in objects )
		{
			var obj = objects[name];

			if( !obj.taken &&
				obj.left !== "undefined" &&
				x >= obj.left &&
				x <= obj.right &&
				y >= obj.top &&
				y <= obj.bottom )
			{
				var a = objects.astronaut;

				a.grab = obj;
				a.grabDist = obj.x-a.x;

				break;
			}
		}

		return true;
	}

	function reset()
	{
		start = new Date().getTime();
		killed = false;
		fireBoostersUntil = 0;
		message = null;

		for( var name in objects )
		{
			var obj = objects[name];

			if( obj.ox !== "undefined" )
				obj.taken = false;
		}

		// reset lamp
		objects.lamp.index = 0;

		// reset astronaut
		{
			var a = objects.astronaut;

			a.grab = null;
			a.hasHelmet = false;
			a.hasSuit = false;
			a.hasComputer = false;
			a.hasPen = false;
			a.x = a.startX;
			a.y = a.startY;
		}
	}

	function loading()
	{
		var stationWidth = Math.round( canvas.width*.9 );

		for( var name in objects )
		{
			var images = objects[name].images;

			for( var n = images.length; n--; )
			{
				var img = images[n];

				if( !img.complete )
				{
					loadTimer = setTimeout( loading, 1000 );
					return;
				}
				else if( typeof( img.cx ) === "undefined" )
				{
					var s = Math.round( img.width/ref[0]*stationWidth );

					if( s < img.width )
					{
						var c = document.createElement( "canvas" );
						c.height = (img.height/img.width)*s;
						c.width = s;

						var ctx = c.getContext( "2d" );
						ctx.drawImage( img, 0, 0, c.width, c.height );

						img = images[n] = c;
					}

					img.cx = Math.round( img.width/2 );
					img.cy = Math.round( img.height/2 );
				}
			}
		}

		// calculate positions for this size
		{
			var img = objects.station.images[0],
				rx = img.width,
				ry = img.height;

			for( var name in objects )
			{
				var obj = objects[name];

				if( obj.ox !== "undefined" )
				{
					obj.x = Math.round( obj.ox/ref[0]*rx );
					obj.y = Math.round( obj.oy/ref[1]*ry );
				}
			}

			moving = 10/ref[0]*rx;

			var a = objects.astronaut;
			a.startX = a.x;
			a.startY = a.y;
		}

		if( !running )
		{
			document.getElementById( "Intro" ).style.display = "none";

			running = true;
			run();
		}
	}

	function load()
	{
		clearTimeout( loadTimer );
		loadTimer = null;

		for( var name in objects )
		{
			var res = objects[name].res,
				images = [];

			for( var n = res.length; n--; )
			{
				var i = new Image();
				i.src = "img/"+res[n];
				images[n] = i;
			}

			objects[name].images = images;
		}

		loading();
	}

	function resize( width, height )
	{
		canvas.resize( width, height );

		centerX = Math.round( width/2 );
		centerY = Math.round( height/2 );

		// set up metrics for this size
		{
			var min = Math.min( width, height );

			objects.venus.swirl = Math.round( min*.25 );
			floating = Math.round( height*.005 );
		}

		fontSize = Math.round( width*.015 );

		load();
	}

	function create( width, height )
	{
		canvas = new Canvas();
		ctx = canvas.context;

		canvas.domElement.onmouseup = click;
		if( "ontouchstart" in document.documentElement )
			canvas.domElement.ontouchend = click;

		reset();
		resize( width, height );

		return canvas.domElement;
	}

	return {
		resize: resize,
		create: create
	};
}());

// shim layer with setTimeout fallback
// see http://paulirish.com/2011/requestanimationframe-for-smart-animating/
window.requestAnimFrame =
	window.requestAnimationFrame ||
	window.webkitRequestAnimationFrame ||
	window.mozRequestAnimationFrame ||
	window.oRequestAnimationFrame ||
	window.msRequestAnimationFrame ||
	function( callback, element )
	{
		window.setTimeout(
			function()
			{
				callback( new Date().getTime() );
			},
			16 );
	};

window.onload = function()
{
	setTimeout(
		function()
		{
			document.body.appendChild(
				Game.create(
					window.innerWidth,
					window.innerHeight ) );

			window.onresize = function()
			{
				Game.resize(
					window.innerWidth,
					window.innerHeight );
			};
		},
		3000 );
};

</script>
</body>
</html>
